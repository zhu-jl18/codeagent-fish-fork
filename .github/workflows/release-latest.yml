name: release-latest

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-latest
  cancel-in-progress: true

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: code-dispatcher/go.mod
          cache: false

      - name: Build cross-platform binaries
        run: bash scripts/build-dist.sh

      - name: Generate checksums
        run: |
          cd dist
          sha256sum code-dispatcher-linux-amd64 code-dispatcher-darwin-arm64 code-dispatcher-windows-amd64.exe > SHA256SUMS

      - name: Force-update latest tag to current commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -f latest "${GITHUB_SHA}"
          git push origin refs/tags/latest --force

      - name: Publish rolling latest release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          if gh release view latest >/dev/null 2>&1; then
            gh release upload latest \
              dist/code-dispatcher-linux-amd64 \
              dist/code-dispatcher-darwin-arm64 \
              dist/code-dispatcher-windows-amd64.exe \
              dist/SHA256SUMS \
              --clobber
            gh release edit latest \
              --title "code-dispatcher latest" \
              --notes "Rolling latest build from main commit ${GITHUB_SHA}" \
              --latest
          else
            gh release create latest \
              dist/code-dispatcher-linux-amd64 \
              dist/code-dispatcher-darwin-arm64 \
              dist/code-dispatcher-windows-amd64.exe \
              dist/SHA256SUMS \
              --title "code-dispatcher latest" \
              --notes "Rolling latest build from main commit ${GITHUB_SHA}" \
              --latest
          fi
